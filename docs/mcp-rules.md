# 大模型调用任务管理MCP服务规则文档

## 1. 调用格式与规范

大模型**必须**使用标准MCP工具调用格式：

```
<mcp:tool name="工具名称">
<mcp:parameter name="参数名">参数值</mcp:parameter>
...
</mcp:tool>
```

**严格规范**：
- 参数名必须与API定义完全匹配，包括大小写
- 字符串参数值不得包含未转义的特殊字符
- 列表类型参数必须使用JSON数组格式
- 每次调用必须等待上一次调用完成后再进行

## 2. 可用工具及参数

### decompose_prd
- **功能**：解析PRD文档，自动拆解为任务列表
- **参数**：
  - `prd_content`: **必填**，字符串，PRD文档内容或资源标识符（支持`file://`协议）
- **返回**：任务对象列表及解析结果说明
- **使用时机**：项目初始化阶段，获取PRD后首先调用

### add_task
- **功能**：创建新任务
- **参数**：
  - `name`: **必填**，任务名称（不超过100字符）
  - `description`: 可选，任务描述
  - `priority`: 可选，任务优先级，可选值为：`low`, `medium`, `high`, `critical`
  - `tags`: 可选，任务标签，多个标签以逗号分隔
  - `assigned_to`: 可选，任务分配给谁
  - `estimated_hours`: 可选，预估完成时间（小时）
  - `dependencies`: 可选，依赖的任务ID，多个依赖以逗号分隔
- **返回**：新创建的任务对象
- **使用时机**：手动添加任务或`decompose_prd`无法满足需求时

### update_task
- **功能**：更新现有任务信息
- **参数**：
  - `task_id`: **必填**，任务ID
  - `name`: 可选，新任务名称
  - `description`: 可选，新任务描述
  - `status`: 可选，新任务状态，必须为`todo`、`in_progress`、`done`、`blocked`或`cancelled`之一
  - `priority`: 可选，新的任务优先级，可选值为：`low`, `medium`, `high`, `critical`
  - `tags`: 可选，新的任务标签，多个标签以逗号分隔
  - `assigned_to`: 可选，新的任务负责人
  - `estimated_hours`: 可选，新的预估完成时间（小时）
  - `actual_hours`: 可选，实际完成时间（小时）
- **返回**：更新后的任务对象
- **使用时机**：任务状态变更（包括标记任务为完成）或信息需要更新时

### get_task
- **功能**：获取任务详情
- **参数**：
  - `task_id`: **必填**，要获取的任务ID
- **返回**：包含任务详细信息的格式化响应
- **使用时机**：需要查看特定任务的详细信息时

### get_task_list
- **功能**：获取任务列表
- **参数**：
  - `status`: 可选，按状态筛选，可选值为：`todo`、`in_progress`、`done`、`blocked`或`cancelled`
  - `priority`: 可选，按优先级筛选，可选值为：`low`、`medium`、`high`、`critical`
  - `tag`: 可选，按标签筛选
  - `assigned_to`: 可选，按负责人筛选
  - `page`: 可选，页码，默认为1
  - `page_size`: 可选，每页数量，默认为100
- **返回**：包含分页任务列表的JSON响应和格式化表格
- **使用时机**：需要查看当前任务状态或进度时

### set_task_dependency
- **功能**：设置任务依赖关系
- **参数**：
  - `task_id`: **必填**，需要添加依赖的任务ID
  - `depends_on_id`: **必填**，被依赖的任务ID
- **返回**：包含依赖设置结果的JSON响应
- **使用时机**：需要建立或修改单个任务依赖关系时

### remove_task_dependency
- **功能**：移除任务依赖关系
- **参数**：
  - `task_id`: **必填**，需要移除依赖的任务ID
  - `depends_on_id`: **必填**，被依赖的任务ID
- **返回**：包含依赖移除结果的JSON响应
- **使用时机**：需要解除特定任务依赖关系时

### get_next_executable_task
- **功能**：获取下一个可执行任务
- **参数**：
  - `limit`: 可选，内部查询任务数量限制，默认为5。该参数仅影响内部查询流程，最终只会返回一个最优先的任务。
- **返回**：包含单个最优先可执行任务的格式化响应
- **使用时机**：寻找当前应执行的任务时
- **处理逻辑**：
  1. 首先查找状态为`in_progress`的任务，优先返回这些任务（应该优先完成已开始的任务）
  2. 如果没有`in_progress`状态的任务，则查找所有状态为`todo`且没有未完成依赖的任务
  3. 按优先级排序（critical > high > medium > low）
  4. 同等优先级下，被更多任务依赖的排前面
  5. 再同等条件下，创建时间早的排前面
  6. 返回排序后的第一个（最优先）任务

### expand_task
- **功能**：为指定任务生成子任务
- **参数**：
  - `task_id`: **必填**，要展开的任务ID
  - `num_subtasks`: 可选，希望生成的子任务数量，默认为5
- **返回**：包含生成的子任务信息和保存的文件路径
- **使用时机**：需要将大任务细分为更小、更具体的子任务时

### update_task_code_references
- **功能**：更新任务实现的代码文件引用
- **参数**：
  - `task_id`: **必填**，要更新的任务ID
  - `code_files`: **必填**，代码文件路径列表，以逗号分隔
- **返回**：包含更新结果的JSON响应
- **使用时机**：任务完成后需要记录相关代码文件时

## 3. 严格调用规则

1. **初始化流程**：
   - 项目开始必须先调用`decompose_prd`或手动使用`add_task`创建任务结构
   - 在任何任务执行前，必须通过`set_task_dependency`验证并完善自动识别的依赖关系

2. **参数验证**：
   - 调用前必须验证所有必填参数已提供且格式正确
   - ID类参数必须确保引用的任务实际存在
   - 列表类型参数必须提供有效的JSON数组，即使为空也要传`[]`

3. **状态转换规则**：
   - 任务状态只能按照以下路径转换：
     * `todo` → `in_progress` → `done`
     * `todo` → `blocked` (当依赖未完成)
     * `blocked` → `todo` (当所有依赖完成)
     * 任意状态 → `cancelled` (明确放弃的任务)
   - 禁止将已完成(`done`)的任务状态回退
   - 禁止将任务直接从`todo`转为`done`，必须经过`in_progress`状态
   - 将任务状态更新为`done`时，必须使用`update_task`并同时更新任务描述或使用`update_task_code_references`添加实现该任务的代码文件路径信息

4. **依赖管理**：
   - 严禁创建循环依赖，系统会自动检测并拒绝此类操作
   - 不得将子任务设置为父任务的依赖
   - 更新父任务状态为`done`前，必须确保所有子任务已完成

5. **错误处理**：
   - 必须处理所有API调用可能返回的错误
   - 遇到错误时应立即停止当前操作流程并恢复到安全状态
   - 不允许在遇到错误后继续向下执行，必须先解决问题

## 4. 标准开发流程

大模型**必须**遵循以下流程进行项目开发：

1. **项目初始化**：
   - 调用`decompose_prd`解析PRD文档，获取初始任务列表及自动识别的依赖关系
   - 检查自动生成的任务是否完整，必要时使用`add_task`补充

2. **依赖关系验证与完善**：
   - 审核`decompose_prd`自动识别的初步依赖关系是否合理
   - 使用`set_task_dependency`完善任务间的依赖关系，添加PRD中未明确但技术实现所必需的依赖
   - 检查并消除可能存在的循环依赖
   - 确认是否存在孤立任务（无依赖也无被依赖），评估其合理性

3. **任务执行循环**：
   - 调用`get_next_executable_task`获取下一个可执行任务（优先返回状态为`in_progress`的任务；若无，则返回状态为`todo`且所有依赖已完成的任务）
   - 如果返回的任务状态为`todo`，使用`update_task`将其状态更新为`in_progress`
   - 执行任务
   - 任务完成后，使用`update_task`将状态更新为`done`，同时使用`update_task_code_references`更新任务相关代码文件
   - 重复以上步骤直到所有任务完成

4. **进度监控**：
   - 定期调用`get_task_list`获取整体任务列表及进度
   - 根据执行情况，适时调整任务优先级或依赖关系

5. **任务拆解**：
   - 对于较大、较复杂的任务，使用`expand_task`将其拆解为多个子任务
   - 确保子任务之间的依赖关系合理，体现正确的执行顺序

6. **异常处理**：
   - 当任务被阻塞时，使用`update_task`将状态标记为`blocked`
   - 解决阻塞问题后，将状态恢复为`todo`
   - 若发现任务描述或拆分不合理，使用`update_task`修正

## 5. 典型错误与禁忌

- **禁止跳过任务**：不得在依赖任务未完成的情况下标记后续任务为完成
- **禁止忽视依赖**：不得在未满足依赖关系的情况下开始执行任务
- **禁止循环依赖**：不得创建A依赖B、B依赖C、C依赖A的循环依赖链
- **禁止频繁修改已完成任务**：已完成任务的描述和依赖关系不应频繁变更
- **禁止不当状态转换**：不得违反状态转换规则进行任意状态修改
- **禁止并行修改**：不得同时对多个相互依赖的任务进行状态修改
- **禁止任务堆积**：不得在有正在进行中的任务时新开始其他任务，应优先完成已开始的任务

按照以上规则和流程严格执行，能够确保项目开发有序进行，避免依赖冲突和状态混乱。 