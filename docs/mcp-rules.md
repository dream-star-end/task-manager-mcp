# 大模型调用任务管理MCP服务规则文档

## 1. 调用格式与规范

大模型**必须**使用标准MCP工具调用格式：

```
<mcp:tool name="工具名称">
<mcp:parameter name="参数名">参数值</mcp:parameter>
...
</mcp:tool>
```

**严格规范**：
- 参数名必须与API定义完全匹配，包括大小写
- 字符串参数值不得包含未转义的特殊字符
- 列表类型参数必须使用JSON数组格式
- 每次调用必须等待上一次调用完成后再进行

## 2. 可用工具及参数

### decompose_prd
- **功能**：解析PRD文档，自动拆解为任务列表
- **参数**：
  - `prd_content`: **必填**，字符串，PRD文档内容或资源标识符（支持`file://`协议）
- **返回**：任务对象列表及解析结果说明
- **使用时机**：项目初始化阶段，获取PRD后首先调用

### add_task
- **功能**：创建新任务
- **参数**：
  - `name`: **必填**，任务名称（不超过100字符）
  - `description`: 可选，任务描述
  - `priority`: 可选，任务优先级，可选值为：`low`, `medium`, `high`, `critical`
  - `tags`: 可选，任务标签，多个标签以逗号分隔
  - `assigned_to`: 可选，任务分配给谁
  - `estimated_hours`: 可选，预估完成时间（小时）
  - `dependencies`: 可选，依赖的任务ID，多个依赖以逗号分隔
- **返回**：新创建的任务对象
- **使用时机**：手动添加任务或`decompose_prd`无法满足需求时

### update_task
- **功能**：更新现有任务信息
- **参数**：
  - `task_id`: **必填**，任务ID
  - `name`: 可选，新任务名称
  - `description`: 可选，新任务描述
  - `status`: 可选，新任务状态，可选值为：`todo`, `in_progress`, `done`, `blocked`, `cancelled`
  - `priority`: 可选，新任务优先级，可选值为：`low`, `medium`, `high`, `critical`
  - `tags`: 可选，新任务标签，多个标签以逗号分隔
  - `assigned_to`: 可选，新任务负责人
  - `estimated_hours`: 可选，新预估完成时间（小时）
  - `actual_hours`: 可选，实际完成时间（小时）
  - `dependencies`: 可选，新的依赖任务ID列表（逗号分隔）。**此操作会覆盖任务现有的所有依赖关系**。如果提供空字符串 `""`，则会清空任务的所有依赖。
- **返回**：更新后的任务对象
- **特殊说明**：
  - 更新子任务状态会自动同步更新父任务状态
  - 可在`description`中通过`[CODE_FILES: file1.py, file2.py]`格式添加代码引用
  - 此工具会覆盖任务的**整个**依赖列表。
- **使用时机**：需要修改任务信息、标记任务状态或完全替换任务依赖关系时

### get_task
- **功能**：获取任务详情
- **参数**：
  - `task_id`: **必填**，要获取的任务ID
- **返回**：包含任务详细信息的格式化响应
- **使用时机**：需要查看特定任务的详细信息时

### get_task_list
- **功能**：获取任务列表
- **参数**：
  - `status`: 可选，按状态筛选，可选值为：`todo`, `in_progress`, `done`, `blocked`, `cancelled`
  - `priority`: 可选，按优先级筛选，可选值为：`low`, `medium`, `high`, `critical`
  - `tag`: 可选，按标签筛选
  - `assigned_to`: 可选，按负责人筛选
  - `page`: 可选，分页页码，默认为1
  - `page_size`: 可选，每页条数，默认为100
- **返回**：任务对象列表及分页信息
- **使用时机**：需要查看或筛选任务列表时

### get_next_executable_task
- **功能**：获取下一个可执行任务
- **参数**：
  - `limit`: 可选，内部查询任务数量限制，默认为5。该参数仅影响内部查询流程，最终只会返回一个最优先的任务。
- **返回**：包含单个最优先可执行任务的格式化响应
- **使用时机**：寻找当前应执行的任务时
- **处理逻辑**：
  1. 首先查找状态为`in_progress`的任务，优先返回这些任务（应该优先完成已开始的任务）
  2. 如果没有`in_progress`状态的任务，则查找所有状态为`todo`且没有未完成依赖的任务
  3. 按优先级排序（critical > high > medium > low）
  4. 同等优先级下，被更多任务依赖的排前面
  5. 再同等条件下，创建时间早的排前面
  6. 返回排序后的第一个（最优先）任务

### expand_task
- **功能**：为指定任务生成子任务
- **参数**：
  - `task_id`: **必填**，要展开的父任务ID
  - `num_subtasks`: 可选，要生成的子任务数量，默认为5
- **返回**：生成的子任务列表及父任务信息
- **特殊说明**：
  - 子任务ID格式为`父任务ID.子任务编号`，如`task-1.1`
  - 子任务存储在父任务的`subtasks`字段中
  - 可以多次调用以生成更多子任务
- **使用时机**：需要将大型任务拆分为更小的可管理任务时

### update_task_code_references
- **功能**：更新任务实现的代码文件引用
- **参数**：
  - `task_id`: **必填**，要更新的任务ID，子任务使用`父任务ID.子任务编号`格式
  - `code_files`: **必填**，代码文件路径列表，以逗号分隔
- **返回**：包含更新结果的JSON响应
- **特殊说明**：
  - 可用于更新主任务或子任务的代码引用
  - 更新子任务时，修改会反映在父任务的`subtasks`字段中
- **使用时机**：任务完成后需要记录相关代码文件时

## 3. 严格调用规则

1. **初始化流程**：
   - 项目开始必须先调用`decompose_prd`或手动使用`add_task`

## 4. 标准开发流程

大模型**必须**遵循以下流程进行项目开发：

1. **项目初始化**：
   - 调用`decompose_prd`解析PRD文档，获取初始主任务列表及自动识别的依赖关系
   - 检查自动生成的任务是否完整，必要时使用`add_task`补充

2. **依赖关系验证与完善**：
   - 审核`decompose_prd`自动识别的初步依赖关系是否合理
   - 使用`update_task`完善任务间的依赖关系，添加PRD中未明确但技术实现所必需的依赖
   - 检查并消除可能存在的循环依赖
   - 确认是否存在孤立任务（无依赖也无被依赖），评估其合理性

3. **任务执行循环**：
   - **a. 获取下一个待处理主任务**：调用`get_next_executable_task`获取下一个可执行的**主任务**（状态为`todo`且依赖完成，或状态为`in_progress`）。
   - **b. 展开主任务为子任务**：如果获取到的主任务状态为`todo`且尚未展开（即`subtasks`字段为空或未包含实际子任务），**必须先调用`expand_task`** 为其生成子任务。
   - **c. 获取下一个待执行子任务**：再次调用`get_next_executable_task`获取下一个可执行的**子任务**（优先返回进行中父任务下的`todo`子任务，或可执行主任务下的`todo`子任务）。
   - **d. 开始执行子任务**：如果获取到的子任务状态为`todo`，使用`update_task`将其状态更新为`in_progress`。
   - **e. 执行子任务**：完成子任务的开发工作。
   - **f. 完成子任务**：任务完成后，使用`update_task`将子任务状态更新为`done`，同时使用`update_task_code_references`更新任务相关代码文件。父任务状态将根据所有子任务状态自动同步。
   - **g. 重复**：回到步骤 c，继续获取并执行下一个子任务，直到当前主任务下的所有子任务完成，然后再回到步骤 a 获取下一个主任务。

4. **进度监控**：
   - 定期调用`get_task_list`获取整体任务列表及进度
   - 根据执行情况，适时调整任务优先级或依赖关系

5. **异常处理**：
   - 当任务被阻塞时，使用`update_task`将状态标记为`blocked`
   - 解决阻塞问题后，将状态恢复为`todo`
   - 若发现任务描述或拆分不合理，使用`update_task`修正

## 5. 典型错误与禁忌